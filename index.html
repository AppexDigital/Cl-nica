<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DentalManager Élite - Gestión de Citas</title>
    
    <!-- Frameworks y Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos de Élite: UI/UX de Aplicación Nativa -->
    <style>
        :root {
            --background: #f8f9fa;
            --foreground: #212529;
            --primary: #10b981; /* Verde Menta (Emerald 500) */
            --primary-hover: #059669; /* Emerald 600 */
            --muted: #dee2e6;
            --card-bg: #ffffff;
            --text-muted: #6c757d;
            --sidebar-bg: #212529; /* Negro Suave */
            --danger: #dc2626; /* Red 600 */
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animaciones y Transiciones de Vista */
        .view {
            animation: view-fade-in 0.6s cubic-bezier(0.215, 0.610, 0.355, 1.000);
        }
        @keyframes view-fade-in {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilo del Loader de Élite */
        .loader-container {
            background-color: var(--background);
        }
        .loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: relative;
            animation: rotate 1s linear infinite
        }
        .loader::before , .loader::after {
            content: "";
            box-sizing: border-box;
            position: absolute;
            inset: 0px;
            border-radius: 50%;
            border: 5px solid var(--foreground);
            animation: prixClipFix 2s linear infinite ;
        }
        .loader::after{
            border-color: var(--primary);
            animation: prixClipFix 2s linear infinite , rotate 0.5s linear infinite reverse;
            inset: 6px;
        }
        @keyframes rotate {
            0%   {transform: rotate(0deg)}
            100%   {transform: rotate(360deg)}
        }
        @keyframes prixClipFix {
            0%   {clip-path:polygon(50% 50%,0 0,0 0,0 0,0 0,0 0)}
            25%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 0,100% 0,100% 0)}
            50%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,100% 100%,100% 100%)}
            75%  {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 100%)}
            100% {clip-path:polygon(50% 50%,0 0,100% 0,100% 100%,0 100%,0 0)}
        }

        /* Ocultar flechas en input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }

        /* Navegación Inferior Móvil */
        .mobile-nav {
            display: none; /* Oculto por defecto */
        }

        @media (max-width: 767px) {
            body {
                padding-bottom: 80px; /* Espacio para la barra de navegación */
            }
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: var(--card-bg);
                border-top: 1px solid var(--muted);
                box-shadow: 0 -2px 15px rgba(0,0,0,0.05);
                z-index: 50;
                justify-content: space-around;
                padding: 8px 0;
            }
            .desktop-sidebar {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Pantalla de Carga Inicial -->
    <div id="loading-overlay" class="loader-container fixed inset-0 flex flex-col items-center justify-center z-[100]">
        <div class="loader"></div>
        <p class="mt-6 text-lg font-semibold text-gray-700">Iniciando DentalManager</p>
    </div>

    <div class="flex min-h-screen">
        <!-- Sidebar de Navegación para Desktop -->
        <aside class="desktop-sidebar bg-slate-800 text-slate-100 w-64 space-y-6 py-7 px-4 shadow-lg flex-shrink-0">
            <div class="px-2">
                <h1 class="text-2xl font-extrabold text-white">Dental<span class="text-emerald-400">Manager</span></h1>
                <p class="text-xs text-slate-400 mt-1">Clínica Sonrisas de Élite</p>
            </div>
            <nav class="mt-10">
                <a href="#" data-view="registrar" class="desktop-nav-link active group flex items-center space-x-3 py-3 px-4 rounded-lg transition-colors duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="font-semibold">Nueva Cita</span>
                </a>
                <a href="#" data-view="consultar" class="desktop-nav-link group flex items-center space-x-3 py-3 px-4 rounded-lg transition-colors duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="font-semibold">Agenda</span>
                </a>
                <a href="#" data-view="reportes" class="desktop-nav-link group flex items-center space-x-3 py-3 px-4 rounded-lg transition-colors duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="font-semibold">Dashboard</span>
                </a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <div class="flex-1 flex flex-col w-full">
            <main class="flex-1 p-4 sm:p-6 md:p-10">
                <!-- Vista: Registrar Cita -->
                <div id="view-registrar" class="view">
                    <div class="max-w-3xl mx-auto">
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200">
                             <h2 class="text-3xl font-bold text-center mb-2 text-slate-800">Agendar una Cita</h2>
                             <p class="text-slate-500 text-center mb-10">Complete los siguientes datos para reservar un espacio.</p>
                            <form id="form-registro" class="space-y-8" novalidate>
                                <fieldset>
                                    <legend class="form-legend">Información del Paciente</legend>
                                    <div class="space-y-6">
                                        <div>
                                            <label for="paciente-nombre" class="form-label">Nombre Completo</label>
                                            <input type="text" id="paciente-nombre" placeholder="Ej: Ana María Rojas" required class="form-input">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div><label for="paciente-cedula" class="form-label">Cédula</label><input type="text" id="paciente-cedula" placeholder="Ej: 1-1234-5678" required class="form-input"></div>
                                            <div><label for="paciente-telefono" class="form-label">Teléfono</label><input type="tel" id="paciente-telefono" placeholder="Ej: 8888-8888" required class="form-input"></div>
                                        </div>
                                    </div>
                                </fieldset>
                                <fieldset>
                                    <legend class="form-legend">Detalles del Tratamiento</legend>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div><label for="cita-fecha" class="form-label">Fecha de la Cita</label><input type="date" id="cita-fecha" required class="form-input"></div>
                                        <div><label for="servicio-select" class="form-label">Servicio</label><select id="servicio-select" required class="form-input"><option value="">-- Seleccionar --</option></select></div>
                                        <div class="md:col-span-2"><label for="doctor-select" class="form-label">Doctor</label><select id="doctor-select" required class="form-input"><option value="">-- Seleccionar --</option></select></div>
                                        <div class="hidden"><label for="servicio-precio" class="form-label">Precio (₡)</label><input type="text" id="servicio-precio" disabled class="form-input bg-slate-100 cursor-not-allowed"></div>
                                        <div class="md:col-span-2"><label for="cita-notas" class="form-label">Notas Adicionales (Opcional)</label><textarea id="cita-notas" rows="4" class="form-input" placeholder="Alergias, historial relevante, etc..."></textarea></div>
                                    </div>
                                </fieldset>
                                <div class="pt-2 text-right"><button type="submit" id="btn-guardar-cita" class="btn-primary w-full md:w-auto">Confirmar Cita</button></div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Vista: Consultar Citas -->
                <div id="view-consultar" class="view hidden">
                    <h2 class="text-4xl font-extrabold mb-2 text-slate-800">Agenda de Citas</h2>
                    <p class="text-slate-500 mb-8">Visualice, filtre y gestione todas las citas programadas.</p>
                    <div class="bg-white p-4 sm:p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200">
                        <div class="mb-6"><input type="text" id="search-input" placeholder="Buscar por nombre de paciente..." class="form-input"></div>
                        <div class="hidden md:block overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-100"><tr><th class="px-6 py-3 rounded-l-lg">Fecha</th><th class="px-6 py-3">Paciente</th><th class="px-6 py-3">Servicio</th><th class="px-6 py-3">Doctor</th><th class="px-6 py-3 text-right">Precio</th><th class="px-6 py-3 text-center">Estado</th><th class="px-6 py-3 text-center rounded-r-lg">Acciones</th></tr></thead><tbody id="citas-table-body"></tbody></table></div>
                        <div id="citas-cards-container" class="md:hidden grid grid-cols-1 gap-4"></div>
                    </div>
                </div>

                <!-- Vista: Reporte Doctores -->
                <div id="view-reportes" class="view hidden">
                    <h2 class="text-4xl font-extrabold mb-2 text-slate-800">Dashboard de Rendimiento</h2>
                    <p class="text-slate-500 mb-8">Análisis de métricas clave y rendimiento por profesional.</p>
                    <div class="space-y-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                                <div>
                                    <label for="reporte-doctor-select" class="form-label">Análisis por Profesional</label>
                                    <select id="reporte-doctor-select" class="w-full form-input mt-1">
                                        <option value="">-- Seleccionar Doctor --</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-center gap-4">
                                    <button id="prev-month-btn" class="p-2.5 rounded-md bg-slate-200 hover:bg-slate-300 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                                    <h3 id="report-period-display" class="text-lg font-bold text-slate-700 text-center w-48"></h3>
                                    <button id="next-month-btn" class="p-2.5 rounded-md bg-slate-200 hover:bg-slate-300 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                                </div>
                            </div>
                        </div>
                        <div id="report-results" class="hidden">
                            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                                <div class="stat-card"><div class="stat-icon bg-blue-100 text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><div><h4 class="stat-title">Citas Facturadas</h4><p id="report-total-citas" class="stat-value">0</p></div></div>
                                <div class="stat-card"><div class="stat-icon bg-green-100 text-green-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div><div><h4 class="stat-title">Ingresos Generados</h4><p id="report-total-vendido" class="stat-value">₡0</p></div></div>
                                <div class="stat-card"><div class="stat-icon bg-emerald-100 text-emerald-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg></div><div><h4 class="stat-title">Comisiones Pagadas</h4><p id="report-total-comisiones" class="stat-value text-emerald-600">₡0</p></div></div>
                                <div class="stat-card"><div class="stat-icon bg-amber-100 text-amber-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg></div><div><h4 class="stat-title">Comisión / Cita</h4><p id="report-avg-comision" class="stat-value">₡0</p></div></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                                <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg border border-slate-200"><h3 class="text-lg font-bold mb-4 text-slate-700">Distribución de Comisiones por Servicio</h3><div class="h-80"><canvas id="commissionChart"></canvas></div></div>
                                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg border border-slate-200"><h3 class="text-lg font-bold mb-4 text-slate-700">Detalle de Citas Facturadas</h3><div class="overflow-y-auto h-80"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0"><tr><th class="px-4 py-2">Fecha</th><th class="px-4 py-2">Paciente</th><th class="px-4 py-2 text-right">Comisión</th></tr></thead><tbody id="report-table-body"></tbody></table></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para Editar Cita -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-[60] p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto view">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Editar Cita</h2>
            <form id="form-edit">
                <input type="hidden" id="edit-cita-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="edit-paciente-nombre" class="form-label">Nombre Completo</label><input type="text" id="edit-paciente-nombre" required class="form-input"></div>
                    <div><label for="edit-paciente-cedula" class="form-label">Cédula</label><input type="text" id="edit-paciente-cedula" class="form-input"></div>
                    <div><label for="edit-paciente-telefono" class="form-label">Teléfono</label><input type="tel" id="edit-paciente-telefono" required class="form-input"></div>
                    <div><label for="edit-cita-fecha" class="form-label">Fecha de la Cita</label><input type="date" id="edit-cita-fecha" required class="form-input"></div>
                    <div><label for="edit-servicio-select" class="form-label">Servicio</label><select id="edit-servicio-select" required class="form-input"></select></div>
                    <div><label for="edit-servicio-precio" class="form-label">Precio (₡)</label><input type="text" id="edit-servicio-precio" disabled class="form-input bg-slate-100"></div>
                    <div class="md:col-span-2"><label for="edit-doctor-select" class="form-label">Doctor</label><select id="edit-doctor-select" required class="form-input"></select></div>
                    <div class="md:col-span-2"><label for="edit-cita-estado" class="form-label">Estado</label><select id="edit-cita-estado" required class="form-input"><option value="Agendada">Agendada</option><option value="Completada">Completada</option><option value="Cancelada">Cancelada</option><option value="Facturada">Facturada</option></select></div>
                    <div class="md:col-span-2"><label for="edit-cita-notas" class="form-label">Notas Adicionales</label><textarea id="edit-cita-notas" rows="3" class="form-input"></textarea></div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" id="cancel-edit" class="btn-secondary">Cancelar</button>
                    <button type="submit" id="btn-guardar-cambios" class="btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Navegación Inferior para Móvil -->
    <footer class="mobile-nav">
        <a href="#" data-view="registrar" class="mobile-nav-link active flex flex-col items-center justify-center text-center w-full p-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-xs font-medium">Nueva Cita</span>
        </a>
        <a href="#" data-view="consultar" class="mobile-nav-link flex flex-col items-center justify-center text-center w-full p-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span class="text-xs font-medium">Agenda</span>
        </a>
        <a href="#" data-view="reportes" class="mobile-nav-link flex flex-col items-center justify-center text-center w-full p-2">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <span class="text-xs font-medium">Dashboard</span>
        </a>
    </footer>

    <!-- Contenedor de Notificaciones -->
    <div id="notification-container" class="fixed bottom-24 md:bottom-5 right-5 z-[70] w-full max-w-xs space-y-3"></div>

    <!-- Clases de Estilo Reutilizables -->
    <style>
        .desktop-nav-link { @apply text-slate-300 hover:bg-slate-700 hover:text-white; }
        .desktop-nav-link.active { @apply bg-emerald-600 text-white; }
        .mobile-nav-link { @apply text-slate-500 transition-colors duration-200; }
        .mobile-nav-link.active { @apply text-emerald-600; }
        .form-label { @apply block text-sm font-semibold text-slate-700; }
        .form-legend { @apply text-xs font-semibold text-slate-500 uppercase tracking-wider pb-2 border-b-2 border-slate-200 w-full; }
        .form-input { @apply block w-full px-4 py-2.5 bg-slate-100 border-2 border-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition; }
        .form-input.error { @apply border-danger ring-1 ring-danger; }
        .btn-primary { 
            background-color: var(--primary);
            color: white;
            @apply inline-flex items-center justify-center font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg transform disabled:bg-slate-400 disabled:shadow-none disabled:transform-none; 
        }
        .btn-primary:hover {
             background-color: var(--primary-hover);
             box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3), 0 4px 6px -2px rgba(16, 185, 129, 0.2);
             transform: translateY(-2px);
        }
        .btn-secondary { @apply bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors; }
        .stat-card { @apply bg-white p-4 rounded-2xl flex items-center gap-4 border border-slate-200 shadow-sm; }
        .stat-icon { @apply rounded-full p-3; }
        .stat-title { @apply text-sm font-medium text-slate-500; }
        .stat-value { @apply text-2xl font-extrabold text-slate-800; }
    </style>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // ===================================================================================
    // ESTADO GLOBAL Y VARIABLES
    // ===================================================================================
    let servicios = [];
    let doctores = [];
    let citas = [];
    let commissionChartInstance = null;
    let currentReportDate = new Date();
    
    // ===================================================================================
    // REFERENCIAS AL DOM
    // ===================================================================================
    const loadingOverlay = document.getElementById('loading-overlay');
    const desktopNavLinks = document.querySelectorAll('.desktop-nav-link');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
    const views = { 
        registrar: document.getElementById('view-registrar'), 
        consultar: document.getElementById('view-consultar'), 
        reportes: document.getElementById('view-reportes') 
    };
    const formRegistro = document.getElementById('form-registro');
    const servicioSelect = document.getElementById('servicio-select');
    const servicioPrecioInput = document.getElementById('servicio-precio');
    const doctorSelect = document.getElementById('doctor-select');
    const citasTableBody = document.getElementById('citas-table-body');
    const citasCardsContainer = document.getElementById('citas-cards-container');
    const searchInput = document.getElementById('search-input');
    const btnGuardarCita = document.getElementById('btn-guardar-cita');
    
    // Elementos del Modal
    const editModal = document.getElementById('edit-modal');
    const formEdit = document.getElementById('form-edit');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const btnGuardarCambios = document.getElementById('btn-guardar-cambios');
    const editCitaId = document.getElementById('edit-cita-id');
    const editServicioSelect = document.getElementById('edit-servicio-select');
    const editDoctorSelect = document.getElementById('edit-doctor-select');
    const editServicioPrecio = document.getElementById('edit-servicio-precio');

    // Elementos de Reportes
    const reporteDoctorSelect = document.getElementById('reporte-doctor-select');
    const reportResults = document.getElementById('report-results');
    const reportTotalCitas = document.getElementById('report-total-citas');
    const reportTotalVendido = document.getElementById('report-total-vendido');
    const reportTotalComisiones = document.getElementById('report-total-comisiones');
    const reportAvgComision = document.getElementById('report-avg-comision');
    const reportTableBody = document.getElementById('report-table-body');
    const reportPeriodDisplay = document.getElementById('report-period-display');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');

    // ===================================================================================
    // LÓGICA DE LA APLICACIÓN
    // ===================================================================================

    // --- Lógica de Carga de Datos ---
    async function cargarDatosIniciales() {
        try {
            const response = await fetch('/.netlify/functions/get-data');
            if (!response.ok) {
                throw new Error(`Error de red: ${response.statusText}`);
            }
            const data = await response.json();

            if (!data || typeof data !== 'object') {
                 throw new Error("La respuesta del servidor no es un objeto JSON válido.");
            }
            
            servicios = (data.servicios || []).map(s => ({ ...s, precio: parseFloat(s.precio) }));
            doctores = (data.doctores || []).map(d => ({ ...d, comision: parseFloat(d.comision) }));
            citas = (data.citas || []).map(c => ({...c, precio: parseFloat(c.precio), comision: parseFloat(c.comision) }));

            initializeApplication();
        } catch (error) {
            console.error('Error fatal al cargar datos:', error);
            showNotification('No se pudieron cargar los datos. Intente recargar la página.', true);
        } finally {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => loadingOverlay.classList.add('hidden'), 500);
        }
    }

    // --- Lógica de Navegación y UI ---
    function switchView(viewName) {
        Object.values(views).forEach(view => view.classList.add('hidden'));
        views[viewName].classList.remove('hidden');
        
        desktopNavLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewName));
        mobileNavLinks.forEach(link => link.classList.toggle('active', link.dataset.view === viewName));
    }

    function showNotification(message, isError = false) {
        const container = document.getElementById('notification-container');
        const notif = document.createElement('div');
        const icon = isError 
            ? `<svg class="w-6 h-6 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            : `<svg class="w-6 h-6 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        
        notif.className = `flex items-center p-4 rounded-xl shadow-2xl text-white ${isError ? 'bg-red-500' : 'bg-green-500'} transition-all duration-300 transform translate-y-4 opacity-0`;
        notif.innerHTML = `${icon}<span>${message}</span>`;
        
        container.appendChild(notif);
        setTimeout(() => notif.classList.remove('translate-y-4', 'opacity-0'), 10);
        setTimeout(() => {
            notif.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => notif.remove(), 500);
        }, 4000);
    }

    // --- Lógica de Formularios y Datos ---
    function populateSelects() {
        const createOption = (value, text) => `<option value="${value}">${text}</option>`;
        const serviceOptions = servicios.map(s => createOption(s.nombre, s.nombre)).join('');
        servicioSelect.innerHTML = '<option value="">-- Seleccionar --</option>' + serviceOptions;
        editServicioSelect.innerHTML = '<option value="">-- Seleccionar --</option>' + serviceOptions;
        const doctorOptions = doctores.map(d => createOption(d.nombre, d.nombre)).join('');
        doctorSelect.innerHTML = '<option value="">-- Seleccionar --</option>' + doctorOptions;
        editDoctorSelect.innerHTML = '<option value="">-- Seleccionar --</option>' + doctorOptions;
        reporteDoctorSelect.innerHTML = '<option value="">-- Todos los doctores --</option>' + doctorOptions;
    }

    function updatePrice(selectElement, priceElement) {
        const selectedService = servicios.find(s => s.nombre === selectElement.value);
        priceElement.value = selectedService ? selectedService.precio.toLocaleString('es-CR') : '';
    }

    function renderCitas(citasToShow = citas) {
        citasTableBody.innerHTML = '';
        citasCardsContainer.innerHTML = '';

        if (citasToShow.length === 0) {
            const noDataRow = `<tr><td colspan="7" class="text-center p-6 text-slate-500">No se encontraron citas.</td></tr>`;
            const noDataCard = `<div class="text-center p-6 text-slate-500">No se encontraron citas.</div>`;
            citasTableBody.innerHTML = noDataRow;
            citasCardsContainer.innerHTML = noDataCard;
            return;
        }

        const sortedCitas = [...citasToShow].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        sortedCitas.forEach(cita => {
            const estadoMap = {
                'Agendada': { text: 'Agendada', class: 'bg-blue-100 text-blue-800' },
                'Completada': { text: 'Completada', class: 'bg-yellow-100 text-yellow-800' },
                'Cancelada': { text: 'Cancelada', class: 'bg-red-100 text-red-800' },
                'Facturada': { text: 'Facturada', class: 'bg-green-100 text-green-800' }
            };
            const estadoInfo = estadoMap[cita.estado] || { text: 'Desconocido', class: 'bg-gray-100 text-gray-800' };
            const precioFormatted = `₡${parseFloat(cita.precio).toLocaleString('es-CR')}`;

            const tableRow = `<tr class="bg-white border-b hover:bg-slate-50 transition-colors"><td class="px-6 py-4">${cita.fecha}</td><td class="px-6 py-4 font-medium text-slate-900">${cita.nombrePaciente}</td><td class="px-6 py-4">${cita.servicio}</td><td class="px-6 py-4">${cita.doctor}</td><td class="px-6 py-4 text-right font-semibold">${precioFormatted}</td><td class="px-6 py-4 text-center"><span class="px-3 py-1 text-xs font-bold rounded-full ${estadoInfo.class}">${estadoInfo.text}</span></td><td class="px-6 py-4 text-center space-x-3"><button data-id="${cita.id}" class="edit-btn font-medium text-emerald-600 hover:text-emerald-800 transition-colors">Editar</button>${cita.estado === 'Completada' ? `<button data-id="${cita.id}" class="invoice-btn font-medium text-green-600 hover:text-green-800 transition-colors">Facturar</button>` : ''}</td></tr>`;
            citasTableBody.innerHTML += tableRow;

            const card = `<div class="bg-white border border-slate-200 rounded-lg shadow-md p-4 space-y-3"><div class="flex justify-between items-start"><div><p class="font-bold text-slate-800">${cita.nombrePaciente}</p><p class="text-sm text-slate-500">${cita.fecha}</p></div><span class="px-2 py-1 text-xs font-bold rounded-full ${estadoInfo.class}">${estadoInfo.text}</span></div><div class="text-sm border-t pt-3"><p><span class="font-semibold">Servicio:</span> ${cita.servicio}</p><p><span class="font-semibold">Doctor:</span> ${cita.doctor}</p><p class="font-bold text-lg text-right mt-2">${precioFormatted}</p></div><div class="flex justify-end space-x-3 border-t pt-3 mt-3">${cita.estado === 'Completada' ? `<button data-id="${cita.id}" class="invoice-btn text-sm font-bold text-green-600">Facturar</button>` : ''}<button data-id="${cita.id}" class="edit-btn text-sm font-bold text-emerald-600">Editar</button></div></div>`;
            citasCardsContainer.innerHTML += card;
        });
    }

    // --- Lógica de Eventos ---
    [...desktopNavLinks, ...mobileNavLinks].forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            switchView(e.currentTarget.dataset.view);
        });
    });
    
    servicioSelect.addEventListener('change', () => updatePrice(servicioSelect, servicioPrecioInput));
    editServicioSelect.addEventListener('change', () => updatePrice(editServicioSelect, editServicioPrecio));

    formRegistro.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        let isValid = true;
        const requiredFields = formRegistro.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            field.classList.remove('error');
            if (!field.value) {
                isValid = false;
                field.classList.add('error');
            }
        });

        if (!isValid) {
            showNotification('Por favor, complete todos los campos obligatorios.', true);
            return;
        }

        btnGuardarCita.disabled = true;
        btnGuardarCita.innerHTML = 'Guardando...';
        const servicioNombre = servicioSelect.value;
        const doctorNombre = doctorSelect.value;
        const servicio = servicios.find(s => s.nombre === servicioNombre);
        const doctor = doctores.find(d => d.nombre === doctorNombre);

        const comisionCalculada = parseFloat(servicio.precio) * (parseFloat(doctor.comision) / 100);

        const newCita = { id: `cita-${Date.now()}`, fecha: document.getElementById('cita-fecha').value, nombrePaciente: document.getElementById('paciente-nombre').value, cedulaPaciente: document.getElementById('paciente-cedula').value, telefonoPaciente: document.getElementById('paciente-telefono').value, servicio: servicio.nombre, precio: servicio.precio, doctor: doctor.nombre, comision: comisionCalculada, estado: 'Agendada', notas: document.getElementById('cita-notas').value };
        try {
            const response = await fetch('/.netlify/functions/add-cita', { method: 'POST', body: JSON.stringify(newCita) });
            if (!response.ok) throw new Error('Error al guardar en el servidor.');
            citas.push(newCita);
            renderCitas();
            formRegistro.reset();
            servicioPrecioInput.value = '';
            showNotification('Cita registrada con éxito.');
            switchView('consultar');
        } catch (error) {
            showNotification('No se pudo guardar la cita.', true);
        } finally {
            btnGuardarCita.disabled = false;
            btnGuardarCita.innerHTML = 'Confirmar Cita';
        }
    });
    
    formRegistro.querySelectorAll('[required]').forEach(field => {
        field.addEventListener('input', () => field.classList.remove('error'));
    });

    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredCitas = citas.filter(c => c.nombrePaciente.toLowerCase().includes(searchTerm));
        renderCitas(filteredCitas);
    });

    const handleCitaActions = (e) => {
        const target = e.target;
        const citaId = target.dataset.id;
        if (!citaId) return;

        if (target.classList.contains('edit-btn')) {
            const cita = citas.find(c => c.id === citaId);
            if (cita) {
                editCitaId.value = cita.id;
                document.getElementById('edit-paciente-nombre').value = cita.nombrePaciente;
                document.getElementById('edit-paciente-cedula').value = cita.cedulaPaciente;
                document.getElementById('edit-paciente-telefono').value = cita.telefonoPaciente;
                document.getElementById('edit-cita-fecha').value = cita.fecha;
                editServicioSelect.value = cita.servicio;
                editServicioPrecio.value = parseFloat(cita.precio).toLocaleString('es-CR');
                editDoctorSelect.value = cita.doctor;
                document.getElementById('edit-cita-estado').value = cita.estado;
                document.getElementById('edit-cita-notas').value = cita.notas;
                editModal.classList.remove('hidden');
            }
        }
        if (target.classList.contains('invoice-btn')) {
            const citaToUpdate = citas.find(c => c.id === citaId);
            if(citaToUpdate) {
                const originalState = citaToUpdate.estado;
                citaToUpdate.estado = 'Facturada';
                updateCitaInBackend(citaToUpdate).then(success => {
                    if (success) {
                        showNotification('Cita marcada como Facturada.');
                        renderCitas();
                    } else {
                        citaToUpdate.estado = originalState;
                        showNotification('No se pudo facturar la cita.', true);
                    }
                });
            }
        }
    };
    citasTableBody.addEventListener('click', handleCitaActions);
    citasCardsContainer.addEventListener('click', handleCitaActions);
    cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));

    async function updateCitaInBackend(citaData) {
        try {
            const response = await fetch('/.netlify/functions/update-cita', { method: 'PUT', body: JSON.stringify(citaData) });
            return response.ok;
        } catch (error) {
            console.error("Error updating cita:", error);
            return false;
        }
    }

    formEdit.addEventListener('submit', async (e) => {
        e.preventDefault();
        btnGuardarCambios.disabled = true;
        btnGuardarCambios.textContent = 'Guardando...';
        const citaId = editCitaId.value;
        const citaIndex = citas.findIndex(c => c.id === citaId);
        if (citaIndex === -1) {
            showNotification('Error: no se encontró la cita.', true);
            btnGuardarCambios.disabled = false;
            btnGuardarCambios.textContent = 'Guardar Cambios';
            return;
        }
        const servicioNombre = document.getElementById('edit-servicio-select').value;
        const doctorNombre = document.getElementById('edit-doctor-select').value;
        const servicio = servicios.find(s => s.nombre === servicioNombre);
        const doctor = doctores.find(d => d.nombre === doctorNombre);
        
        const comisionCalculada = parseFloat(servicio.precio) * (parseFloat(doctor.comision) / 100);

        const updatedCita = { ...citas[citaIndex], nombrePaciente: document.getElementById('edit-paciente-nombre').value, cedulaPaciente: document.getElementById('edit-paciente-cedula').value, telefonoPaciente: document.getElementById('edit-paciente-telefono').value, fecha: document.getElementById('edit-cita-fecha').value, servicio: servicio.nombre, precio: servicio.precio, doctor: doctor.nombre, comision: comisionCalculada, estado: document.getElementById('edit-cita-estado').value, notas: document.getElementById('edit-cita-notas').value };
        const success = await updateCitaInBackend(updatedCita);
        if (success) {
            citas[citaIndex] = updatedCita;
            renderCitas();
            editModal.classList.add('hidden');
            showNotification('Cita actualizada con éxito.');
        } else {
            showNotification('No se pudo actualizar la cita.', true);
        }
        btnGuardarCambios.disabled = false;
        btnGuardarCambios.textContent = 'Guardar Cambios';
    });

    // --- Lógica de Reportes ---
    function updatePeriodDisplay() {
        reportPeriodDisplay.textContent = currentReportDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    }
    
    prevMonthBtn.addEventListener('click', () => {
        currentReportDate.setMonth(currentReportDate.getMonth() - 1);
        displayReport();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentReportDate.setMonth(currentReportDate.getMonth() + 1);
        displayReport();
    });

    reporteDoctorSelect.addEventListener('change', displayReport);

    function displayReport() {
        const selectedDoctor = reporteDoctorSelect.value;
        
        if (!selectedDoctor) {
            reportResults.classList.add('hidden');
            return;
        }

        updatePeriodDisplay();

        const year = currentReportDate.getFullYear();
        const month = currentReportDate.getMonth();

        let filteredCitas = citas.filter(c => {
            const citaDate = new Date(c.fecha);
            return c.doctor === selectedDoctor && 
                   (c.estado === 'Completada' || c.estado === 'Facturada') &&
                   citaDate.getFullYear() === year &&
                   citaDate.getMonth() === month;
        });
        
        const totalVendido = filteredCitas.reduce((sum, cita) => sum + parseFloat(cita.precio), 0);
        const totalComisiones = filteredCitas.reduce((sum, cita) => sum + parseFloat(cita.comision), 0);
        const totalCitasCompletadas = filteredCitas.length;
        const avgComision = totalCitasCompletadas > 0 ? totalComisiones / totalCitasCompletadas : 0;
        const formatCurrency = (value) => `₡${value.toLocaleString('es-CR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        
        reportTotalCitas.textContent = totalCitasCompletadas;
        reportTotalVendido.textContent = formatCurrency(totalVendido);
        reportTotalComisiones.textContent = formatCurrency(totalComisiones);
        reportAvgComision.textContent = formatCurrency(avgComision);
        
        reportTableBody.innerHTML = '';
        if (filteredCitas.length > 0) {
            filteredCitas.forEach(cita => {
                reportTableBody.innerHTML += `<tr class="border-b border-slate-100 last:border-b-0"><td class="px-4 py-3">${cita.fecha}</td><td class="px-4 py-3 font-medium text-slate-700">${cita.nombrePaciente}</td><td class="px-4 py-3 text-right font-semibold text-emerald-600">${formatCurrency(cita.comision)}</td></tr>`;
            });
        } else {
            reportTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-6 text-slate-400">No hay citas facturadas para este periodo.</td></tr>`;
        }
        
        const comisionesPorServicio = filteredCitas.reduce((acc, cita) => {
            acc[cita.servicio] = (acc[cita.servicio] || 0) + parseFloat(cita.comision);
            return acc;
        }, {});
        const chartLabels = Object.keys(comisionesPorServicio);
        const chartData = Object.values(comisionesPorServicio);

        if (commissionChartInstance) commissionChartInstance.destroy();
        const ctx = document.getElementById('commissionChart').getContext('2d');
        commissionChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: chartLabels, datasets: [{ label: 'Comisiones', data: chartData, backgroundColor: ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5'], borderColor: '#fff', borderWidth: 3 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed)}` } } } }
        });
        reportResults.classList.remove('hidden');
    }

    // --- Inicialización de la Aplicación ---
    function initializeApplication() {
        populateSelects();
        renderCitas();
        reporteDoctorSelect.addEventListener('change', () => {
            currentReportDate = new Date(); // Reset date when doctor changes
            displayReport();
        });
        switchView('registrar');
    }

    cargarDatosIniciales();
});
</script>

</body>
</html>
